require 'open3'

class MalwareScanner
  ClamdscanError = Class.new(StandardError)

  def self.call(file_path)
    new(file_path: file_path).call
  end

  attr_reader :file_path

  def initialize(file_path:)
    @file_path = file_path
  end

  def call
    return false if disable_malware_scanner?

    virus_found?
  end

  private

  def disable_malware_scanner?
    Rails.env.development?
  end

  def virus_found?
    @virus_found ||= !scan_result.status.success?
  end

  def scan_result
    @scan_result ||= begin
                       stdout, stderr, status = Open3.capture3(*([command, file_path.to_s].join(' ')))
                       result = stdout.strip

                       raise ClamdscanError, (stderr.presence || stdout) if status.exitstatus == 2

                       OpenStruct.new(
                         result: result,
                         status: status
                       )
                     end
  end

  def command
    "/usr/bin/clamdscan -c config/clamd/#{Rails.env}.conf --stream --no-summary".freeze
  end
end
